{
  "active": false,
  "connections": {
    "Telegram Trigger1": {
      "main": [
        [
          {
            "node": "Check for Repeat Meal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Photo1": {
      "main": [
        [
          {
            "node": "Download Photo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze Text with AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo1": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Photo with AI1": {
      "main": [
        [
          {
            "node": "Calculate Nutrition1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Text with AI1": {
      "main": [
        [
          {
            "node": "Calculate Nutrition1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Nutrition1": {
      "main": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add to Notion1": {
      "main": [
        [
          {
            "node": "Get Daily Totals1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Daily Totals1": {
      "main": [
        [
          {
            "node": "Format Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response1": {
      "main": [
        [
          {
            "node": "Send Reply1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Analyze Photo with AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Nutrition with AI Agent": {
      "main": [
        [
          {
            "node": "Finalize for Notion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "DEEPSEEK": {
      "ai_languageModel": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Finalize for Notion": {
      "main": [
        [
          {
            "node": "Add to Notion1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Check for Repeat Meal": {
      "main": [
        [
          {
            "node": "Extract Search Term",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check if Photo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Message & Keyboard": {
      "main": [
        [
          {
            "node": "Send Meal Options",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Search Results": {
      "main": [
        [
          {
            "node": "Check for Any Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Result Count": {
      "main": [
        [
          {
            "node": "Log Single Meal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Message & Keyboard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Item Count": {
      "main": [
        [
          {
            "node": "Route by Result Count",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Any Results": {
      "main": [
        [
          {
            "node": "Get Item Count",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search for Past Meals": {
      "main": [
        [
          {
            "node": "Filter Search Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Search Term": {
      "main": [
        [
          {
            "node": "Search for Past Meals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Get the Selected Meal's Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the Selected Meal's Details": {
      "main": [
        [
          {
            "node": "Log the Meal for Today",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-31T20:23:08.831Z",
  "id": "Yf6YjC3YW7XD98Qh",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "MACRO TRACKER BOT with call back query",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {},
        "path": "831fb3f8-21d2-460b-9508-0a5a4ee6c7e9"
      },
      "id": "12e1edba-acc2-42fb-9feb-7c4c0827c83f",
      "name": "Telegram Trigger1",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        1056,
        1408
      ],
      "webhookId": "831fb3f8-21d2-460b-9508-0a5a4ee6c7e9",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.message.photo }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "id": "4e004642-5176-46a3-8ef9-8d9e967fc852",
      "name": "Check if Photo1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1408,
        1792
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger1').item.json.message.photo[3].file_id }}",
        "path": "365d2659-a162-4e4d-8d04-e8317dc2e21f"
      },
      "id": "8f5871b5-943d-4178-9f3d-f8d935f524ba",
      "name": "Download Photo1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1616,
        1680
      ],
      "webhookId": "365d2659-a162-4e4d-8d04-e8317dc2e21f",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n({\n  \"model\": \"mistralai/mistral-small-3.1-24b-instruct:free\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": `You are an advanced nutrition calculator. Your task is to calculate the **total nutritional information for a complete meal** based on a user's text caption and an accompanying image.\n\nYour job is to intelligently combine information from both the text and the image:\n\n1.  **Analyze the Text:** Read the user's caption to understand the meal. Any specific quantities mentioned in the text (e.g., \"18 pizza rolls\", \"about 8oz\") are the **primary source of truth** and should be used.\n2.  **Analyze the Image:** Use the image to visually identify the food items.\n    * **If the caption asks you to count discrete items**, you must count them and use that number.\n    * **If no portion size is given in the text for an item like a steak or fries**, you may attempt to **estimate the portion size** (e.g., in grams or ounces) from the photo as a rough 'ballpark' guess.\n3.  **Calculate:** Combine all information to **sum up the nutrition for the ENTIRE meal.**\n\n**Priority:** Always prefer a portion size written in the caption over your own visual estimate.\n\nReturn ONLY a single JSON object with the final, calculated totals. If you make an estimate, reflect that in the food name.\n{\n  \"food_name\": \"A descriptive name of the meal, like '18 Pizza Rolls' or 'Est. 8oz Steak & Fries'\",\n  \"calories\": number,\n  \"protein\": number,\n  \"fat\": number,\n  \"carbs\": number,\n  \"fiber\": number\n}`\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": $('Telegram Trigger1').item.json.message.caption || ''\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": `data:image/jpeg;base64,${$json.base64Image}`\n          }\n        }\n      ]\n    }\n  ],\n  \"response_format\": { \"type\": \"json_object\" }\n})\n}}",
        "options": {}
      },
      "id": "2d05faf1-2f9c-4987-a8cc-cc32b72ec1cb",
      "name": "Analyze Photo with AI1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2048,
        1680
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "i6X3fH9gEWk4yda5",
          "name": "VERTEX API ACCESS"
        },
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={{\n({\n  \"model\": \"mistralai/mistral-small-3.1-24b-instruct:free\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": `You are an advanced nutrition calculator. Your task is to calculate the **total nutritional information for a complete meal** described by the user in the text they provide.\n\nYour job is to:\n1.  Read the user's text to identify all food items and their quantities (e.g., \"6 ounces of black coffee\", \"One serving of this protein shake\").\n2.  Use your own knowledge for the nutritional values.\n3.  If the user provides new information about the Nutrition of one of the items follow that to the best of your ability and reconcile it with your own knowledge.\n4.  **Sum up the nutrition for ALL items to get a final total for the entire meal.**\n\nReturn ONLY a single JSON object with the final, calculated totals. The food name should be a summary of the meal.\n{\n  \"food_name\": \"A descriptive name of the meal, like 'Chicken and Rice' or 'Protein Shake' or \"Chic-Fil-A Nugget Meal\",\n  \"calories\": number,\n  \"protein\": number,\n  \"fat\": number,\n  \"carbs\": number,\n  \"fiber\": number\n}`\n    },\n    {\n      \"role\": \"user\",\n      \"content\": $('Telegram Trigger1').item.json.message.text || ''\n    }\n  ],\n  \"response_format\": { \"type\": \"json_object\" }\n})\n}}",
        "options": {}
      },
      "id": "e9e1249e-75f1-4e73-ade5-5efb862361e0",
      "name": "Analyze Text with AI1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1616,
        1888
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "i6X3fH9gEWk4yda5",
          "name": "VERTEX API ACCESS"
        },
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the AI's response which contains the final calculated totals\nconst aiResponse = JSON.parse($input.first().json.choices[0].message.content);\nconst userMessage = $('Telegram Trigger1').item.json.message;\n\n// Combine the AI response with user and time data\nconst result = {\n  ...aiResponse, // This adds food_name, calories, protein, etc. from the AI\n  date: new Date().toISOString().split('T')[0],\n  time: new Date().toLocaleTimeString('en-US', {\n    hour12: false,\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone: 'America/Chicago'\n  }),\n  telegram_user_id: userMessage.from.id,\n  telegram_username: userMessage.from.username || userMessage.from.first_name\n};\n\nreturn { json: result };"
      },
      "id": "24cb2dea-94b5-42ad-8634-31d3243e6047",
      "name": "Calculate Nutrition1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2272,
        1792
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "title": "={{ $json.output.food_name }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Date|date",
              "includeTime": false,
              "date": "={{ $json.date }}",
              "timezone": "America/Chicago"
            },
            {
              "key": "Time|rich_text",
              "textContent": "={{ $json.time }}"
            },
            {
              "key": "Calories|number",
              "numberValue": "={{ $json.output.calories }}"
            },
            {
              "key": "Protein (g)|number",
              "numberValue": "={{ $json.output.protein }}"
            },
            {
              "key": "Fat (g)|number",
              "numberValue": "={{ $json.output.fat }}"
            },
            {
              "key": "Carbs (g)|number",
              "numberValue": "={{ $json.output.carbs }}"
            },
            {
              "key": "Fiber (g)|number",
              "numberValue": "={{ $json.output.fiber }}"
            }
          ]
        },
        "options": {}
      },
      "id": "b25072cb-1c0d-4d78-81fa-ac0262368b56",
      "name": "Add to Notion1",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        3088,
        1792
      ],
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "returnAll": true,
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Date|date",
              "condition": "equals",
              "date": "=={{ $now.toISODate() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "3fb46e6d-1941-4cc0-a7e7-24ed4d2aab96",
      "name": "Get Daily Totals1",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        3296,
        1792
      ],
      "alwaysOutputData": true,
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Calculate daily totals from Notion results\nconst notionResults = $input.all();\nconst currentMeal = $('Calculate Nutrition1').item.json;\n\nlet dailyTotals = {\n  calories: 0,\n  protein: 0,\n  fat: 0,\n  carbs: 0,\n  fiber: 0\n};\n\n// Sum up all entries for today\nif (notionResults && notionResults.length > 0) {\n  notionResults.forEach(item => {\n    if (item.json && item.json.properties) {\n      const props = item.json.properties;\n      dailyTotals.calories += props.Calories?.number || 0;\n      dailyTotals.protein += props['Protein (g)']?.number || 0;\n      dailyTotals.fat += props['Fat (g)']?.number || 0;\n      dailyTotals.carbs += props['Carbs (g)']?.number || 0;\n      dailyTotals.fiber += props['Fiber (g)']?.number || 0;\n    }\n  });\n}\n\n// Round the totals\ndailyTotals.calories = Math.round(dailyTotals.calories);\ndailyTotals.protein = Math.round(dailyTotals.protein * 10) / 10;\ndailyTotals.fat = Math.round(dailyTotals.fat * 10) / 10;\ndailyTotals.carbs = Math.round(dailyTotals.carbs * 10) / 10;\ndailyTotals.fiber = Math.round(dailyTotals.fiber * 10) / 10;\n\n// Create response message\nconst mealSummary = `ðŸ½ï¸ **Meal Logged: ${currentMeal.food_name}**\\n` +\n  `ðŸ“Š **This Meal:**\\n` +\n  `â€¢ Calories: ${currentMeal.calories}\\n` +\n  `â€¢ Protein: ${currentMeal.protein}g\\n` +\n  `â€¢ Fat: ${currentMeal.fat}g\\n` +\n  `â€¢ Carbs: ${currentMeal.carbs}g\\n` +\n  `â€¢ Fiber: ${currentMeal.fiber}g\\n\\n` +\n  `ðŸ“ˆ **Today's Totals:**\\n` +\n  `â€¢ Calories: ${dailyTotals.calories}\\n` +\n  `â€¢ Protein: ${dailyTotals.protein}g\\n` +\n  `â€¢ Fat: ${dailyTotals.fat}g\\n` +\n  `â€¢ Carbs: ${dailyTotals.carbs}g\\n` +\n  `â€¢ Fiber: ${dailyTotals.fiber}g`;\n\nreturn {\n  json: {\n    message: mealSummary,\n    chat_id: $('Telegram Trigger1').item.json.message.chat.id,\n    currentMeal: currentMeal,\n    dailyTotals: dailyTotals\n  }\n};"
      },
      "id": "35252bfe-d2b7-4b5a-9c08-ac3c2bb8258f",
      "name": "Format Response1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3520,
        1792
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        },
        "path": "7416dbe6-b259-497f-845d-9c2de766ae34"
      },
      "id": "b937ae5a-367e-4519-a7ff-a232f0315e4e",
      "name": "Send Reply1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        3744,
        1792
      ],
      "webhookId": "7416dbe6-b259-497f-845d-9c2de766ae34",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "base64Image",
        "options": {
          "keepSource": "json"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1824,
        1680
      ],
      "id": "49f5bcad-7cea-48dc-b9c7-39ccc754aaaf",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify($input.first().json) }}\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a meticulous nutrition data verifier. Your job is to check if the provided nutritional data for a given meal description is reasonable. The initial calculation was done by another AI, and you are the quality check.\n\nI will provide you with a JSON object containing a 'food_name' and its calculated nutrition.\n\nIf the numbers seem reasonable for the food described, return the JSON object exactly as you received it.\n\nIf the numbers seem wildly incorrect (e.g., 1700 calories for a piece of chicken), recalculate them based on your knowledge and return a JSON object with the corrected values.\n\nDo not add any explanation, apologies, or extra text. Your output MUST be only the JSON object in the exact same format as the input.\n\nHere is the required format:\n{\n\"food_name\": \"A descriptive name of the meal\",\n\"calories\": number,\n\"protein\": number,\n\"fat\": number,\n\"carbs\": number,\n\"fiber\": number\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        2480,
        1792
      ],
      "id": "521e32ab-3f5f-496e-8e97-8dbb268ea891",
      "name": "Verify Nutrition with AI Agent"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"food_name\": {\n      \"type\": \"string\",\n      \"description\": \"A descriptive name of the meal, like 'Chicken and Rice' or 'Protein Shake'\"\n    },\n    \"calories\": {\n      \"type\": \"number\",\n      \"description\": \"Total calories for the meal\"\n    },\n    \"protein\": {\n      \"type\": \"number\",\n      \"description\": \"Total protein in grams for the meal\"\n    },\n    \"fat\": {\n      \"type\": \"number\",\n      \"description\": \"Total fat in grams for the meal\"\n    },\n    \"carbs\": {\n      \"type\": \"number\",\n      \"description\": \"Total carbs in grams for the meal\"\n    },\n    \"fiber\": {\n      \"type\": \"number\",\n      \"description\": \"Total fiber in grams for the meal\"\n    }\n  },\n  \"required\": [\n    \"food_name\",\n    \"calories\",\n    \"protein\",\n    \"fat\",\n    \"carbs\",\n    \"fiber\"\n  ]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2656,
        2080
      ],
      "id": "7f02f2b8-1d09-480e-b43b-0cdd5328d4d2",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": "deepseek/deepseek-chat-v3-0324:free",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2416,
        2080
      ],
      "id": "7f9ac198-8e54-4d79-8205-93b712c6788e",
      "name": "DEEPSEEK",
      "credentials": {
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the original data from before the verification step\nconst originalData = $('Calculate Nutrition1').item.json;\n\n// Get the verified data from the verifier AI\n// Note: The AI Agent node might put the response in a different place than the HTTP node.\n// We'll check for a 'content' or direct property.\nconst aiResponse = $input.first().json;\nconst verifiedDataString = aiResponse.content || JSON.stringify(aiResponse);\nconst verifiedData = JSON.parse(verifiedDataString);\n\n\n// Combine them into the final object for Notion\nconst result = {\n  ...verifiedData, // Use the verified food_name, calories, protein, etc.\n  date: originalData.date,\n  time: originalData.time,\n  telegram_user_id: originalData.telegram_user_id,\n  telegram_username: originalData.telegram_username,\n};\n\nreturn { json: result };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2832,
        1792
      ],
      "id": "5a9c98a2-577c-48c6-8bec-59acfd21426b",
      "name": "Finalize for Notion"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        2592,
        2000
      ],
      "id": "fe09a1c2-20a0-4c4f-9d1f-b4449484f83c",
      "name": "Think"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "82734dab-de4f-418b-acd7-7485d6e8896d",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "normal",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "63e63973-a2f5-402b-aaee-9546be611f65",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "usual",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "0e64cfc4-9e15-4d56-8182-1c5220efbab5",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "typical",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "a2ce2d07-aa07-48ba-bd79-82ebae1d05c8",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "daily",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "4bcfbca9-bc67-49ac-8864-71c2c73de7f1",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "favorite",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "3aef39c6-ab66-4662-946b-5f02910fb676",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "standard",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "63c0d5b1-fc13-4c72-8d03-243ece6bc007",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "regular",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "9638da24-2f79-4a7f-8554-dcf7af16b4ec",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "go-to",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "702a9fb7-35dd-4d3c-b6b3-1ddc75ccb0f7",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "again",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "1203f4a7-9f7d-4756-8e75-722a6c235937",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "repeat",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1264,
        1408
      ],
      "id": "f0eb9eeb-23dd-49fc-9bca-1fb14ef8445d",
      "name": "Check for Repeat Meal"
    },
    {
      "parameters": {
        "jsCode": "// This code creates the message and buttons using valid Telegram HTML.\nlet replyMessage = \"I found a few options. Which one did you have?\";\n\n// Create the button rows for the inline keyboard.\nconst buttonRows = items.map((item, index) => {\n  const mealName = item.json.property_food_item;\n  \n  // Add each meal to the message. The <pre> tag preserves the newline.\n  replyMessage += `\\n<pre>${index + 1}. ${mealName}</pre>`;\n\n  return [{\n    text: mealName,\n    callback_data: `log_meal:${item.json.id}`\n  }];\n});\n\nconst replyMarkup = { inline_keyboard: buttonRows };\n\n// Return the final message object.\nreturn [{\n  json: {\n    telegramMessage: replyMessage,\n    reply_markup: replyMarkup\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3280,
        1200
      ],
      "id": "883b52cd-f60f-43fc-9895-c82cc66be1bf",
      "name": "Create Message & Keyboard"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger1').first().json.message.chat.id }}\n\n",
        "text": "={{ $json.telegramMessage }}",
        "replyMarkup": "={{ $json.reply_markup }}",
        "forceReply": {},
        "replyKeyboardOptions": {},
        "replyKeyboardRemove": {},
        "additionalFields": {
          "parse_mode": "HTML"
        },
        "path": "cd39c275-de97-4efd-96b5-55d74d8ab261"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3536,
        1200
      ],
      "id": "d6ad287c-cd6c-453c-a27c-a0dffa67898f",
      "name": "Send Meal Options",
      "webhookId": "cd39c275-de97-4efd-96b5-55d74d8ab261",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the search words from the 'Extract Search Term' node\nconst searchWords = $('Extract Search Term').item.json.searchWords;\n\n// Filter the items using the simplified data structure\nconst filteredItems = items.filter(item => {\n  // Safety check: ensure the meal name property exists and is a string\n  if (!item.json || typeof item.json.property_food_item !== 'string') {\n    return false;\n  }\n  \n  // Get the title, which is already a simple string in your data\n  const title = item.json.property_food_item.toLowerCase();\n  \n  // Check if every search word is in the title\n  return searchWords.every(word => title.includes(word.toLowerCase()));\n});\n\n// Return the correctly filtered items\nreturn filteredItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2064,
        1312
      ],
      "id": "8ae6f29d-7648-4c13-ba5c-adf38c15bf47",
      "name": "Filter Search Results"
    },
    {
      "parameters": {
        "jsCode": "const currentItem = items[0];\n// Calculate the length of the items array and add it as a new property\ncurrentItem.json.actualItemCount = items.length;\n\nconsole.log('Code Node \"Get Item Count\": Calculated actualItemCount as:', currentItem.json.actualItemCount);\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2512,
        1216
      ],
      "id": "ac0c0100-005d-446f-93a5-6d48c8b730e0",
      "name": "Get Item Count"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.actualItemCount }}",
                    "rightValue": 1,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "710e95ae-c3f9-48eb-9606-d40d9fdba6b2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Single"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "allMatchingOutputs": true
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2800,
        1120
      ],
      "id": "70741fbf-40e3-4e15-a678-f6e02d8de252",
      "name": "Route by Result Count",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "title": "={{ $('Search for Past Meals').item.json.name }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Date|date",
              "includeTime": false,
              "date": "={{ new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' }) }}",
              "timezone": "America/Chicago"
            },
            {
              "key": "Time|rich_text",
              "textContent": "={{ new Date($('Telegram Trigger1').item.json.message.date * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'America/Chicago' }) }}"
            },
            {
              "key": "Calories|number",
              "numberValue": "={{ $json.property_calories }}"
            },
            {
              "key": "Protein (g)|number",
              "numberValue": "={{ $json.property_protein_g }}"
            },
            {
              "key": "Fat (g)|number",
              "numberValue": "={{ $json.property_fat_g }}"
            },
            {
              "key": "Carbs (g)|number",
              "numberValue": "={{ $json.property_carbs_g }}"
            },
            {
              "key": "Fiber (g)|number",
              "numberValue": "={{ $json.property_fiber_g }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        3280,
        960
      ],
      "id": "66209e68-ba1c-44ce-823c-8c0ea064e9dc",
      "name": "Log Single Meal",
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger1').item.json.message.chat.id }}",
        "text": "=Sorry, I couldn't find any past meals matching {{ $('Extract Search Term').item.json.searchTerm }}.  Please try describing a new meal.",
        "additionalFields": {},
        "path": "ecea0981-6484-450a-9ee7-7e86ac471105"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2896,
        1408
      ],
      "id": "c55a4457-70fa-497a-bf6b-92eb8b808aa6",
      "name": "Send a text message",
      "webhookId": "ecea0981-6484-450a-9ee7-7e86ac471105",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b26b622b-5aaf-4f52-9dd5-3f9435b85869",
              "leftValue": "={{ $items.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2304,
        1312
      ],
      "id": "464492b4-2c92-4839-832b-05ae85762e41",
      "name": "Check for Any Results"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1856,
        1312
      ],
      "id": "e361682c-9297-4526-8e9d-c6799e85eede",
      "name": "Search for Past Meals",
      "alwaysOutputData": false,
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the first item from the input array.\n// In \"Run Once for All Items\" mode, 'items' is an array of all input items.\nconsole.log('--- Extract Search Term: Starting execution ---');\nconsole.log('Input items received:', items.length, 'items');\n\nif (!items || items.length === 0) {\n    console.error('Error: No input items. Exiting gracefully.');\n    return []; // Return an empty array if no input, to prevent crashing on items[0]\n}\n\nconst currentItem = items[0];\nconsole.log('First item structure (partial):', JSON.stringify(currentItem.json.message));\n\n// Access the message from the currentItem's JSON data\n// Add a check to ensure 'text' property exists and is a string\nif (!currentItem.json || !currentItem.json.message || typeof currentItem.json.message.text !== 'string') {\n    console.error('Error: Message text is missing or not a string. Exiting.');\n    return [];\n}\nconst message = currentItem.json.message.text.toLowerCase();\nconsole.log('Original message (lowercase):', message);\n\n// List of keywords to remove from the message to find the search term\nconst keywords = [\n  'my', 'the', 'a', 'an',\n  'normal', 'usual', 'typical', 'daily',\n  'favorite', 'standard', 'regular',\n  'go-to', 'again', 'repeat', 'same as'\n];\n\nlet searchTerm = message;\nconsole.log('Initial searchTerm:', searchTerm);\n\nfor (const keyword of keywords) {\n  // This removes the keyword as a whole word\n  const regex = new RegExp(`\\\\b${keyword}\\\\b`, 'gi');\n  console.log(`Applying regex /\\\\b${keyword}\\\\b/gi to: \"${searchTerm}\"`);\n  searchTerm = searchTerm.replace(regex, '');\n  console.log('searchTerm after keyword removal:', searchTerm);\n}\n\n// Clean up any extra spaces left behind and add it to the current item's JSON\n// ****** THIS IS THE CRITICAL CHANGE ******\ncurrentItem.json.searchWords = searchTerm.split(' ').filter(word => word.length > 0);\nconsole.log('Final searchTerm added to item.json:', currentItem.json.searchTerm);\n\n// Return the modified array of items\nconsole.log('--- Extract Search Term: Returning items ---');\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1616,
        1312
      ],
      "id": "8f858645-a9e9-4e16-b919-f00841e47ccf",
      "name": "Extract Search Term"
    },
    {
      "parameters": {
        "updates": [
          "callback_query"
        ],
        "additionalFields": {},
        "path": "bc601529-9078-4445-a6a5-a36881b371c9"
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        3808,
        1408
      ],
      "id": "9f948dfd-3d8b-4403-8d96-5cf390deebb6",
      "name": "Telegram Trigger",
      "webhookId": "bc601529-9078-4445-a6a5-a36881b371c9",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "get",
        "pageId": {
          "__rl": true,
          "value": "={{ $json.data.split(':')[1] }}",
          "mode": "id"
        }
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        4016,
        1408
      ],
      "id": "0aaa0f81-c785-43e8-ba43-75f3e6d5f7ef",
      "name": "Get the Selected Meal's Details",
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        4224,
        1408
      ],
      "id": "d4b341aa-d4c7-47b4-91a9-4f794ed1913c",
      "name": "Log the Meal for Today",
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    }
  ],
  "pinData": {
    "Telegram Trigger1": [
      {
        "json": {
          "update_id": 600519790,
          "message": {
            "message_id": 49,
            "from": {
              "id": 7439997846,
              "is_bot": false,
              "first_name": "KC",
              "last_name": "Uke",
              "language_code": "en"
            },
            "chat": {
              "id": 7439997846,
              "first_name": "KC",
              "last_name": "Uke",
              "type": "private"
            },
            "date": 1753981586,
            "text": "My normal protein coffee"
          }
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-07-31T20:23:08.831Z",
      "updatedAt": "2025-07-31T20:23:08.831Z",
      "role": "workflow:owner",
      "workflowId": "Yf6YjC3YW7XD98Qh",
      "projectId": "aYesZFcPjHzYQyLq"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2025-07-31T20:23:08.831Z",
  "versionId": "785baa1e-9085-4919-860d-a313344f32dd"
}