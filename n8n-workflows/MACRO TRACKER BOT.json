{
  "active": true,
  "connections": {
    "Telegram Trigger1": {
      "main": [
        [
          {
            "node": "Check for Repeat Meal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Photo1": {
      "main": [
        [
          {
            "node": "Download Photo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze Text with AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo1": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Photo with AI1": {
      "main": [
        [
          {
            "node": "Calculate Nutrition1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Text with AI1": {
      "main": [
        [
          {
            "node": "Calculate Nutrition1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Nutrition1": {
      "main": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add to Notion1": {
      "main": [
        [
          {
            "node": "Get Daily Totals1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Daily Totals1": {
      "main": [
        [
          {
            "node": "Format Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response1": {
      "main": [
        [
          {
            "node": "Send Reply1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Analyze Photo with AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Nutrition with AI Agent": {
      "main": [
        [
          {
            "node": "Finalize for Notion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "DEEPSEEK": {
      "ai_languageModel": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Finalize for Notion": {
      "main": [
        [
          {
            "node": "Add to Notion1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Check for Repeat Meal": {
      "main": [
        [
          {
            "node": "Extract Search Term",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check if Photo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Search Term": {
      "main": [
        [
          {
            "node": "Search for Past Meals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search for Past Meals": {
      "main": [
        [
          {
            "node": "Filter Search Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check for Any Results": {
      "main": [
        [
          {
            "node": "Select First Match",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Search Results": {
      "main": [
        [
          {
            "node": "Check for Any Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Best Match": {
      "main": [
        [
          {
            "node": "Get Daily Totals1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select First Match": {
      "main": [
        [
          {
            "node": "Log Best Match",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-29T21:39:10.584Z",
  "id": "F3sFsVZEGBagFzKv",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "MACRO TRACKER BOT",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "4a63bac7-61bf-418e-92bb-e1f5b97e7f6a",
      "name": "Telegram Trigger1",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        1056,
        1408
      ],
      "webhookId": "your-webhook-id",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.message.photo }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "id": "311c262a-3408-4c61-862f-3c057019e855",
      "name": "Check if Photo1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1408,
        1792
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger1').item.json.message.photo[3].file_id }}"
      },
      "id": "98a8383e-2a38-4cd6-a143-ffbaefd8fd4e",
      "name": "Download Photo1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1616,
        1680
      ],
      "webhookId": "8f0493b8-d0a8-45db-8878-bed33c6712cd",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n({\n  \"model\": \"mistralai/mistral-small-3.1-24b-instruct:free\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": `You are an advanced nutrition calculator. Your task is to calculate the **total nutritional information for a complete meal** based on a user's text caption and an accompanying image.\n\nYour job is to intelligently combine information from both the text and the image:\n\n1.  **Analyze the Text:** Read the user's caption to understand the meal. Any specific quantities mentioned in the text (e.g., \"18 pizza rolls\", \"about 8oz\") are the **primary source of truth** and should be used.\n2.  **Analyze the Image:** Use the image to visually identify the food items.\n    * **If the caption asks you to count discrete items**, you must count them and use that number.\n    * **If no portion size is given in the text for an item like a steak or fries**, you may attempt to **estimate the portion size** (e.g., in grams or ounces) from the photo as a rough 'ballpark' guess.\n3.  **Calculate:** Combine all information to **sum up the nutrition for the ENTIRE meal.**\n\n**Priority:** Always prefer a portion size written in the caption over your own visual estimate.\n\nReturn ONLY a single JSON object with the final, calculated totals. If you make an estimate, reflect that in the food name.\n{\n  \"food_name\": \"A descriptive name of the meal, like '18 Pizza Rolls' or 'Est. 8oz Steak & Fries'\",\n  \"calories\": number,\n  \"protein\": number,\n  \"fat\": number,\n  \"carbs\": number,\n  \"fiber\": number\n}`\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": $('Telegram Trigger1').item.json.message.caption || ''\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": `data:image/jpeg;base64,${$json.base64Image}`\n          }\n        }\n      ]\n    }\n  ],\n  \"response_format\": { \"type\": \"json_object\" }\n})\n}}",
        "options": {}
      },
      "id": "5ed59bf0-84b5-4dc1-8e04-2c7628666793",
      "name": "Analyze Photo with AI1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2048,
        1680
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "i6X3fH9gEWk4yda5",
          "name": "VERTEX API ACCESS"
        },
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={{\n({\n  \"model\": \"mistralai/mistral-small-3.1-24b-instruct:free\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": `You are an advanced nutrition calculator. Your task is to calculate the **total nutritional information for a complete meal** described by the user in the text they provide.\n\nYour job is to:\n1.  Read the user's text to identify all food items and their quantities (e.g., \"6 ounces of black coffee\", \"One serving of this protein shake\").\n2.  Use your own knowledge for the nutritional values.\n3.  If the user provides new information about the Nutrition of one of the items follow that to the best of your ability and reconcile it with your own knowledge.\n4.  **Sum up the nutrition for ALL items to get a final total for the entire meal.**\n\nReturn ONLY a single JSON object with the final, calculated totals. The food name should be a summary of the meal.\n{\n  \"food_name\": \"A descriptive name of the meal, like 'Chicken and Rice' or 'Protein Shake' or \"Chic-Fil-A Nugget Meal\",\n  \"calories\": number,\n  \"protein\": number,\n  \"fat\": number,\n  \"carbs\": number,\n  \"fiber\": number\n}`\n    },\n    {\n      \"role\": \"user\",\n      \"content\": $('Telegram Trigger1').item.json.message.text || ''\n    }\n  ],\n  \"response_format\": { \"type\": \"json_object\" }\n})\n}}",
        "options": {}
      },
      "id": "3f6b005b-1d36-4607-acba-127f2a860499",
      "name": "Analyze Text with AI1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1616,
        1888
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "i6X3fH9gEWk4yda5",
          "name": "VERTEX API ACCESS"
        },
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the AI's response which contains the final calculated totals\nconst aiResponse = JSON.parse($input.first().json.choices[0].message.content);\nconst userMessage = $('Telegram Trigger1').item.json.message;\n\n// Combine the AI response with user and time data\nconst result = {\n  ...aiResponse, // This adds food_name, calories, protein, etc. from the AI\n  date: new Date().toISOString().split('T')[0],\n  time: new Date().toLocaleTimeString('en-US', {\n    hour12: false,\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone: 'America/Chicago'\n  }),\n  telegram_user_id: userMessage.from.id,\n  telegram_username: userMessage.from.username || userMessage.from.first_name\n};\n\nreturn { json: result };"
      },
      "id": "29f14ba8-3dec-4006-b95f-6a039cbb9bc4",
      "name": "Calculate Nutrition1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2272,
        1792
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "title": "={{ $json.output.food_name }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Date|date",
              "includeTime": false,
              "date": "={{ $json.date }}",
              "timezone": "America/Chicago"
            },
            {
              "key": "Time|rich_text",
              "textContent": "={{ $json.time }}"
            },
            {
              "key": "Calories|number",
              "numberValue": "={{ $json.output.calories }}"
            },
            {
              "key": "Protein (g)|number",
              "numberValue": "={{ $json.output.protein }}"
            },
            {
              "key": "Fat (g)|number",
              "numberValue": "={{ $json.output.fat }}"
            },
            {
              "key": "Carbs (g)|number",
              "numberValue": "={{ $json.output.carbs }}"
            },
            {
              "key": "Fiber (g)|number",
              "numberValue": "={{ $json.output.fiber }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4e391cc0-fd65-4e13-9f99-4fe648b42cca",
      "name": "Add to Notion1",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        3072,
        1792
      ],
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "returnAll": true,
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Date|date",
              "condition": "equals",
              "date": "=={{ $now.toISODate() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "b220d5a2-a7d7-4b79-9d2b-f09996b4b38f",
      "name": "Get Daily Totals1",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        3408,
        1792
      ],
      "alwaysOutputData": true,
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Get all of today's meals from the input.\nconst notionResults = $input.all();\n\n// 2. Find the MOST RECENT meal by sorting the list by creation time.\nnotionResults.sort((a, b) => new Date(b.json.created_time) - new Date(a.json.created_time));\nconst mostRecentMeal = notionResults[0];\n\n// 3. Extract the details of that most recent meal for the summary.\nconst mealProps = mostRecentMeal.json.properties;\nconst currentMeal = {\n  // THIS LINE IS NOW CORRECTED to use 'Food Item'\n  food_name: mealProps['Food Item']?.title[0]?.plain_text || 'Unknown Meal',\n  calories: mealProps['Calories']?.number || 0,\n  protein: mealProps['Protein (g)']?.number || 0,\n  fat: mealProps['Fat (g)']?.number || 0,\n  carbs: mealProps['Carbs (g)']?.number || 0,\n  fiber: mealProps['Fiber (g)']?.number || 0\n};\n\n// 4. Calculate daily totals using ALL of today's meals.\nlet dailyTotals = { calories: 0, protein: 0, fat: 0, carbs: 0, fiber: 0 };\n\nnotionResults.forEach(item => {\n  const itemProps = item.json.properties;\n  dailyTotals.calories += itemProps['Calories']?.number || 0;\n  dailyTotals.protein += itemProps['Protein (g)']?.number || 0;\n  dailyTotals.fat += itemProps['Fat (g)']?.number || 0;\n  dailyTotals.carbs += itemProps['Carbs (g)']?.number || 0;\n  dailyTotals.fiber += itemProps['Fiber (g)']?.number || 0;\n});\n\n// 5. Round the totals.\nObject.keys(dailyTotals).forEach(key => {\n  dailyTotals[key] = Math.round(dailyTotals[key]);\n});\n\n// 6. Create the final response message.\nconst mealSummary = `ðŸ½ï¸ **Meal Logged: ${currentMeal.food_name}**\\n` +\n  `ðŸ“Š **This Meal:**\\n` +\n  `â€¢ Calories: ${currentMeal.calories}\\n` +\n  `â€¢ Protein: ${currentMeal.protein}g\\n` +\n  `â€¢ Fat: ${currentMeal.fat}g\\n` +\n  `â€¢ Carbs: ${currentMeal.carbs}g\\n` +\n  `â€¢ Fiber: ${currentMeal.fiber}g\\n\\n` +\n  `ðŸ“ˆ **Today's Totals:**\\n` +\n  `â€¢ Calories: ${dailyTotals.calories}\\n` +\n  `â€¢ Protein: ${dailyTotals.protein}g\\n` +\n  `â€¢ Fat: ${dailyTotals.fat}g\\n` +\n  `â€¢ Carbs: ${dailyTotals.carbs}g\\n` +\n  `â€¢ Fiber: ${dailyTotals.fiber}g`;\n\n// 7. Return the final object for the Telegram node.\nreturn [{\n  json: {\n    message: mealSummary,\n    chat_id: $('Telegram Trigger1').item.json.message.chat.id,\n    dailyTotals: dailyTotals,\n  },\n}];"
      },
      "id": "dbbf59f5-bb10-4e12-ad67-8366b6d88f59",
      "name": "Format Response1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3664,
        1792
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "13c0e715-b3e1-477c-a592-08971738e48d",
      "name": "Send Reply1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        3872,
        1792
      ],
      "webhookId": "9302096e-b24d-4e26-af7e-6b275f806e78",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "base64Image",
        "options": {
          "keepSource": "json"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1824,
        1680
      ],
      "id": "a015ff52-a41d-4dca-b76d-4a261b82c32a",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify($input.first().json) }}\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a meticulous nutrition data verifier. Your job is to check if the provided nutritional data for a given meal description is reasonable. The initial calculation was done by another AI, and you are the quality check.\n\nI will provide you with a JSON object containing a 'food_name' and its calculated nutrition.\n\nIf the numbers seem reasonable for the food described, return the JSON object exactly as you received it.\n\nIf the numbers seem wildly incorrect (e.g., 1700 calories for a piece of chicken), recalculate them based on your knowledge and return a JSON object with the corrected values.\n\nDo not add any explanation, apologies, or extra text. Your output MUST be only the JSON object in the exact same format as the input.\n\nHere is the required format:\n{\n\"food_name\": \"A descriptive name of the meal\",\n\"calories\": number,\n\"protein\": number,\n\"fat\": number,\n\"carbs\": number,\n\"fiber\": number\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        2480,
        1792
      ],
      "id": "0c203247-29b2-494c-8423-ab618d9ac6ff",
      "name": "Verify Nutrition with AI Agent"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"food_name\": {\n      \"type\": \"string\",\n      \"description\": \"A descriptive name of the meal, like 'Chicken and Rice' or 'Protein Shake'\"\n    },\n    \"calories\": {\n      \"type\": \"number\",\n      \"description\": \"Total calories for the meal\"\n    },\n    \"protein\": {\n      \"type\": \"number\",\n      \"description\": \"Total protein in grams for the meal\"\n    },\n    \"fat\": {\n      \"type\": \"number\",\n      \"description\": \"Total fat in grams for the meal\"\n    },\n    \"carbs\": {\n      \"type\": \"number\",\n      \"description\": \"Total carbs in grams for the meal\"\n    },\n    \"fiber\": {\n      \"type\": \"number\",\n      \"description\": \"Total fiber in grams for the meal\"\n    }\n  },\n  \"required\": [\n    \"food_name\",\n    \"calories\",\n    \"protein\",\n    \"fat\",\n    \"carbs\",\n    \"fiber\"\n  ]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2656,
        2080
      ],
      "id": "20cd6194-4a60-4087-82d0-451739e3c0d7",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": "deepseek/deepseek-chat-v3-0324:free",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2416,
        2080
      ],
      "id": "caf8d993-58a0-4ebf-aeaa-27b20355c12c",
      "name": "DEEPSEEK",
      "credentials": {
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the original data from before the verification step\nconst originalData = $('Calculate Nutrition1').item.json;\n\n// Get the verified data from the verifier AI\n// Note: The AI Agent node might put the response in a different place than the HTTP node.\n// We'll check for a 'content' or direct property.\nconst aiResponse = $input.first().json;\nconst verifiedDataString = aiResponse.content || JSON.stringify(aiResponse);\nconst verifiedData = JSON.parse(verifiedDataString);\n\n\n// Combine them into the final object for Notion\nconst result = {\n  ...verifiedData, // Use the verified food_name, calories, protein, etc.\n  date: originalData.date,\n  time: originalData.time,\n  telegram_user_id: originalData.telegram_user_id,\n  telegram_username: originalData.telegram_username,\n};\n\nreturn { json: result };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2832,
        1792
      ],
      "id": "ac3a7ce2-c846-4342-993d-cc9dd5d29827",
      "name": "Finalize for Notion"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        2592,
        2000
      ],
      "id": "5eb7a8f4-b1fd-42bd-aece-47ea7d37208a",
      "name": "Think"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "82734dab-de4f-418b-acd7-7485d6e8896d",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "normal",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "63e63973-a2f5-402b-aaee-9546be611f65",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "usual",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "0e64cfc4-9e15-4d56-8182-1c5220efbab5",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "typical",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "a2ce2d07-aa07-48ba-bd79-82ebae1d05c8",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "daily",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "4bcfbca9-bc67-49ac-8864-71c2c73de7f1",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "favorite",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "3aef39c6-ab66-4662-946b-5f02910fb676",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "standard",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "63c0d5b1-fc13-4c72-8d03-243ece6bc007",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "regular",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "9638da24-2f79-4a7f-8554-dcf7af16b4ec",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "go-to",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "702a9fb7-35dd-4d3c-b6b3-1ddc75ccb0f7",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "again",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "1203f4a7-9f7d-4756-8e75-722a6c235937",
              "leftValue": "={{ $('Telegram Trigger1').item.json.message.text }}",
              "rightValue": "repeat",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1264,
        1408
      ],
      "id": "f5072598-f2fb-4416-9cde-c505a62c4124",
      "name": "Check for Repeat Meal"
    },
    {
      "parameters": {
        "jsCode": "// Get the first item from the input array.\n// In \"Run Once for All Items\" mode, 'items' is an array of all input items.\nconsole.log('--- Extract Search Term: Starting execution ---');\nconsole.log('Input items received:', items.length, 'items');\n\nif (!items || items.length === 0) {\n    console.error('Error: No input items. Exiting gracefully.');\n    return []; // Return an empty array if no input, to prevent crashing on items[0]\n}\n\nconst currentItem = items[0];\nconsole.log('First item structure (partial):', JSON.stringify(currentItem.json.message));\n\n// Access the message from the currentItem's JSON data\n// Add a check to ensure 'text' property exists and is a string\nif (!currentItem.json || !currentItem.json.message || typeof currentItem.json.message.text !== 'string') {\n    console.error('Error: Message text is missing or not a string. Exiting.');\n    return [];\n}\nconst message = currentItem.json.message.text.toLowerCase();\nconsole.log('Original message (lowercase):', message);\n\n// List of keywords to remove from the message to find the search term\nconst keywords = [\n  'my', 'the', 'a', 'an', 'meal',\n  'normal', 'usual', 'typical', 'daily',\n  'favorite', 'standard', 'regular',\n  'go-to', 'again', 'repeat', 'same as'\n];\n\nlet searchTerm = message;\nconsole.log('Initial searchTerm:', searchTerm);\n\nfor (const keyword of keywords) {\n  // This removes the keyword as a whole word\n  const regex = new RegExp(`\\\\b${keyword}\\\\b`, 'gi');\n  console.log(`Applying regex /\\\\b${keyword}\\\\b/gi to: \"${searchTerm}\"`);\n  searchTerm = searchTerm.replace(regex, '');\n  console.log('searchTerm after keyword removal:', searchTerm);\n}\n\n// Clean up any extra spaces left behind and add it to the current item's JSON\n// ****** THIS IS THE CRITICAL CHANGE ******\ncurrentItem.json.searchWords = searchTerm.split(' ').filter(word => word.length > 0);\nconsole.log('Final searchTerm added to item.json:', currentItem.json.searchTerm);\n\n// Return the modified array of items\nconsole.log('--- Extract Search Term: Returning items ---');\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1616,
        1312
      ],
      "id": "49a36277-b7a7-4a57-8365-31fde3a6787a",
      "name": "Extract Search Term"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "returnAll": true,
        "options": {}
      },
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1856,
        1312
      ],
      "id": "93532297-fc99-4ff1-bf78-386ae3e9ad42",
      "name": "Search for Past Meals",
      "alwaysOutputData": false,
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b26b622b-5aaf-4f52-9dd5-3f9435b85869",
              "leftValue": "={{ $items.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2304,
        1312
      ],
      "id": "fde73a72-45d0-481c-85a8-f6b52a64f4cc",
      "name": "Check for Any Results"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger1').item.json.message.chat.id }}",
        "text": "=Sorry, I couldn't find any past meals matching {{ $('Extract Search Term').item.json.searchTerm }}.  Please try describing a new meal.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2560,
        1392
      ],
      "id": "68f2e282-9f68-4b4d-a100-a45051d41ae8",
      "name": "Send a text message",
      "webhookId": "595c1ee8-7f95-4595-9c78-de006325efe3",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the search words from the 'Extract Search Term' node\nconst searchWords = $('Extract Search Term').item.json.searchWords;\n\n// Rank each item from Notion based on how many search words its title contains\nconst rankedItems = items.map(item => {\n  // Safety check to skip empty items\n  if (!item.json || typeof item.json.property_food_item !== 'string' || item.json.property_food_item === '') {\n    return { item: item, matchCount: 0 };\n  }\n  \n  const title = item.json.property_food_item.toLowerCase();\n  \n  // Count how many search words are found in the title\n  let count = 0;\n  for (const word of searchWords) {\n    if (title.includes(word)) {\n      count++;\n    }\n  }\n  \n  return { item: item, matchCount: count };\n});\n\n// Filter out any items that had zero matches\nconst matchedItems = rankedItems.filter(rankedItem => rankedItem.matchCount > 0);\n\n// Sort the results so the meal with the highest score is first\nmatchedItems.sort((a, b) => b.matchCount - a.matchCount);\n\n// Return the sorted list of meals\nreturn matchedItems.map(rankedItem => rankedItem.item);"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2064,
        1312
      ],
      "id": "ea6fc447-936a-490f-a0e5-1eab88ce4def",
      "name": "Filter Search Results"
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "title": "={{ $json.property_food_item }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Date|date",
              "includeTime": false,
              "date": "={{ $now.toISODate() }}",
              "timezone": "America/Chicago"
            },
            {
              "key": "Time|rich_text",
              "textContent": "={{ new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'America/Chicago' }) }}"
            },
            {
              "key": "Calories|number",
              "numberValue": "={{ $json.property_calories }}"
            },
            {
              "key": "Protein (g)|number",
              "numberValue": "={{ $json.property_protein_g }}"
            },
            {
              "key": "Fat (g)|number",
              "numberValue": "={{ $json.property_fat_g }}"
            },
            {
              "key": "Carbs (g)|number",
              "numberValue": "={{ $json.property_carbs_g }}"
            },
            {
              "key": "Fiber (g)|number",
              "numberValue": "={{ $json.property_fiber_g }}"
            }
          ]
        },
        "options": {}
      },
      "id": "cd0a057e-b2f6-4c7d-8124-992bb125072d",
      "name": "Log Best Match",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        2864,
        1184
      ],
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// The input 'items' is an array of all matching meals.\n// We only want to log the first one.\nconst firstMatch = items[0];\n\n// Return just the single item for the next node.\nreturn firstMatch;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2576,
        1184
      ],
      "id": "9aa9f604-a5ca-4eef-a9c3-9dc1ac1a4d62",
      "name": "Select First Match"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-07-29T21:39:10.584Z",
      "updatedAt": "2025-07-29T21:39:10.584Z",
      "role": "workflow:owner",
      "workflowId": "F3sFsVZEGBagFzKv",
      "projectId": "aYesZFcPjHzYQyLq"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-07-31T21:35:35.029Z",
  "versionId": "64bff377-0be5-46cb-8596-521ac908d411"
}