{
  "active": true,
  "connections": {
    "Telegram Trigger1": {
      "main": [
        [
          {
            "node": "Check if Photo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Photo1": {
      "main": [
        [
          {
            "node": "Download Photo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze Text with AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo1": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Photo with AI1": {
      "main": [
        [
          {
            "node": "Calculate Nutrition1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Text with AI1": {
      "main": [
        [
          {
            "node": "Calculate Nutrition1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Nutrition1": {
      "main": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add to Notion1": {
      "main": [
        [
          {
            "node": "Get Daily Totals1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Daily Totals1": {
      "main": [
        [
          {
            "node": "Format Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response1": {
      "main": [
        [
          {
            "node": "Send Reply1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Analyze Photo with AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Nutrition with AI Agent": {
      "main": [
        [
          {
            "node": "Finalize for Notion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "DEEPSEEK": {
      "ai_languageModel": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Finalize for Notion": {
      "main": [
        [
          {
            "node": "Add to Notion1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Verify Nutrition with AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-07-29T21:39:10.584Z",
  "id": "F3sFsVZEGBagFzKv",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "MACRO TRACKER BOT",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "4a63bac7-61bf-418e-92bb-e1f5b97e7f6a",
      "name": "Telegram Trigger1",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        976,
        1792
      ],
      "webhookId": "your-webhook-id",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.message.photo }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "id": "311c262a-3408-4c61-862f-3c057019e855",
      "name": "Check if Photo1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1200,
        1792
      ]
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $('Telegram Trigger1').item.json.message.photo[3].file_id }}"
      },
      "id": "98a8383e-2a38-4cd6-a143-ffbaefd8fd4e",
      "name": "Download Photo1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1408,
        1680
      ],
      "webhookId": "8f0493b8-d0a8-45db-8878-bed33c6712cd",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{\n({\n  \"model\": \"mistralai/mistral-small-3.1-24b-instruct:free\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": `You are an advanced nutrition calculator. Your task is to calculate the **total nutritional information for a complete meal** based on a user's text caption and an accompanying image.\n\nYour job is to intelligently combine information from both the text and the image:\n\n1.  **Analyze the Text:** Read the user's caption to understand the meal. Any specific quantities mentioned in the text (e.g., \"18 pizza rolls\", \"about 8oz\") are the **primary source of truth** and should be used.\n2.  **Analyze the Image:** Use the image to visually identify the food items.\n    * **If the caption asks you to count discrete items**, you must count them and use that number.\n    * **If no portion size is given in the text for an item like a steak or fries**, you may attempt to **estimate the portion size** (e.g., in grams or ounces) from the photo as a rough 'ballpark' guess.\n3.  **Calculate:** Combine all information to **sum up the nutrition for the ENTIRE meal.**\n\n**Priority:** Always prefer a portion size written in the caption over your own visual estimate.\n\nReturn ONLY a single JSON object with the final, calculated totals. If you make an estimate, reflect that in the food name.\n{\n  \"food_name\": \"A descriptive name of the meal, like '18 Pizza Rolls' or 'Est. 8oz Steak & Fries'\",\n  \"calories\": number,\n  \"protein\": number,\n  \"fat\": number,\n  \"carbs\": number,\n  \"fiber\": number\n}`\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": $('Telegram Trigger1').item.json.message.caption || ''\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": `data:image/jpeg;base64,${$json.base64Image}`\n          }\n        }\n      ]\n    }\n  ],\n  \"response_format\": { \"type\": \"json_object\" }\n})\n}}",
        "options": {}
      },
      "id": "5ed59bf0-84b5-4dc1-8e04-2c7628666793",
      "name": "Analyze Photo with AI1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1840,
        1680
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "i6X3fH9gEWk4yda5",
          "name": "VERTEX API ACCESS"
        },
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={{\n({\n  \"model\": \"mistralai/mistral-small-3.1-24b-instruct:free\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": `You are an advanced nutrition calculator. Your task is to calculate the **total nutritional information for a complete meal** described by the user in the text they provide.\n\nYour job is to:\n1.  Read the user's text to identify all food items and their quantities (e.g., \"6 ounces of black coffee\", \"One serving of this protein shake\").\n2.  Use your own knowledge for the nutritional values.\n3.  If the user provides new information about the Nutrition of one of the items follow that to the best of your ability and reconcile it with your own knowledge.\n4.  **Sum up the nutrition for ALL items to get a final total for the entire meal.**\n\nReturn ONLY a single JSON object with the final, calculated totals. The food name should be a summary of the meal.\n{\n  \"food_name\": \"A descriptive name of the meal, like 'Chicken and Rice' or 'Protein Shake' or \"Chic-Fil-A Nugget Meal\",\n  \"calories\": number,\n  \"protein\": number,\n  \"fat\": number,\n  \"carbs\": number,\n  \"fiber\": number\n}`\n    },\n    {\n      \"role\": \"user\",\n      \"content\": $('Telegram Trigger1').item.json.message.text || ''\n    }\n  ],\n  \"response_format\": { \"type\": \"json_object\" }\n})\n}}",
        "options": {}
      },
      "id": "3f6b005b-1d36-4607-acba-127f2a860499",
      "name": "Analyze Text with AI1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1408,
        1888
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "i6X3fH9gEWk4yda5",
          "name": "VERTEX API ACCESS"
        },
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the AI's response which contains the final calculated totals\nconst aiResponse = JSON.parse($input.first().json.choices[0].message.content);\nconst userMessage = $('Telegram Trigger1').item.json.message;\n\n// Combine the AI response with user and time data\nconst result = {\n  ...aiResponse, // This adds food_name, calories, protein, etc. from the AI\n  date: new Date().toISOString().split('T')[0],\n  time: new Date().toLocaleTimeString('en-US', {\n    hour12: false,\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone: 'America/Chicago'\n  }),\n  telegram_user_id: userMessage.from.id,\n  telegram_username: userMessage.from.username || userMessage.from.first_name\n};\n\nreturn { json: result };"
      },
      "id": "29f14ba8-3dec-4006-b95f-6a039cbb9bc4",
      "name": "Calculate Nutrition1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2064,
        1792
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "title": "={{ $json.output.food_name }}",
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "Date|date",
              "includeTime": false,
              "date": "={{ $json.date }}",
              "timezone": "America/Chicago"
            },
            {
              "key": "Time|rich_text",
              "textContent": "={{ $json.time }}"
            },
            {
              "key": "Calories|number",
              "numberValue": "={{ $json.output.calories }}"
            },
            {
              "key": "Protein (g)|number",
              "numberValue": "={{ $json.output.protein }}"
            },
            {
              "key": "Fat (g)|number",
              "numberValue": "={{ $json.output.fat }}"
            },
            {
              "key": "Carbs (g)|number",
              "numberValue": "={{ $json.output.carbs }}"
            },
            {
              "key": "Fiber (g)|number",
              "numberValue": "={{ $json.output.fiber }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4e391cc0-fd65-4e13-9f99-4fe648b42cca",
      "name": "Add to Notion1",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        2880,
        1792
      ],
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "241541c0-2b31-8077-ba98-eec6adda6f48",
          "mode": "list",
          "cachedResultName": "Food Tracker",
          "cachedResultUrl": "https://www.notion.so/241541c02b318077ba98eec6adda6f48"
        },
        "returnAll": true,
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Date|date",
              "condition": "equals",
              "date": "=={{ $now.toISODate() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "b220d5a2-a7d7-4b79-9d2b-f09996b4b38f",
      "name": "Get Daily Totals1",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2,
      "position": [
        3088,
        1792
      ],
      "alwaysOutputData": true,
      "credentials": {
        "notionApi": {
          "id": "X9pMOV66IStKRydY",
          "name": "Notion account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Calculate daily totals from Notion results\nconst notionResults = $input.all();\nconst currentMeal = $('Calculate Nutrition1').item.json;\n\nlet dailyTotals = {\n  calories: 0,\n  protein: 0,\n  fat: 0,\n  carbs: 0,\n  fiber: 0\n};\n\n// Sum up all entries for today\nif (notionResults && notionResults.length > 0) {\n  notionResults.forEach(item => {\n    if (item.json && item.json.properties) {\n      const props = item.json.properties;\n      dailyTotals.calories += props.Calories?.number || 0;\n      dailyTotals.protein += props['Protein (g)']?.number || 0;\n      dailyTotals.fat += props['Fat (g)']?.number || 0;\n      dailyTotals.carbs += props['Carbs (g)']?.number || 0;\n      dailyTotals.fiber += props['Fiber (g)']?.number || 0;\n    }\n  });\n}\n\n// Round the totals\ndailyTotals.calories = Math.round(dailyTotals.calories);\ndailyTotals.protein = Math.round(dailyTotals.protein * 10) / 10;\ndailyTotals.fat = Math.round(dailyTotals.fat * 10) / 10;\ndailyTotals.carbs = Math.round(dailyTotals.carbs * 10) / 10;\ndailyTotals.fiber = Math.round(dailyTotals.fiber * 10) / 10;\n\n// Create response message\nconst mealSummary = `üçΩÔ∏è **Meal Logged: ${currentMeal.food_name}**\\n` +\n  `üìä **This Meal:**\\n` +\n  `‚Ä¢ Calories: ${currentMeal.calories}\\n` +\n  `‚Ä¢ Protein: ${currentMeal.protein}g\\n` +\n  `‚Ä¢ Fat: ${currentMeal.fat}g\\n` +\n  `‚Ä¢ Carbs: ${currentMeal.carbs}g\\n` +\n  `‚Ä¢ Fiber: ${currentMeal.fiber}g\\n\\n` +\n  `üìà **Today's Totals:**\\n` +\n  `‚Ä¢ Calories: ${dailyTotals.calories}\\n` +\n  `‚Ä¢ Protein: ${dailyTotals.protein}g\\n` +\n  `‚Ä¢ Fat: ${dailyTotals.fat}g\\n` +\n  `‚Ä¢ Carbs: ${dailyTotals.carbs}g\\n` +\n  `‚Ä¢ Fiber: ${dailyTotals.fiber}g`;\n\nreturn {\n  json: {\n    message: mealSummary,\n    chat_id: $('Telegram Trigger1').item.json.message.chat.id,\n    currentMeal: currentMeal,\n    dailyTotals: dailyTotals\n  }\n};"
      },
      "id": "dbbf59f5-bb10-4e12-ad67-8366b6d88f59",
      "name": "Format Response1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3312,
        1792
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "id": "13c0e715-b3e1-477c-a592-08971738e48d",
      "name": "Send Reply1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        3536,
        1792
      ],
      "webhookId": "9302096e-b24d-4e26-af7e-6b275f806e78",
      "credentials": {
        "telegramApi": {
          "id": "UQ0TGFdRm981nAK4",
          "name": "Telegram - MACRO TRACKER"
        }
      }
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "base64Image",
        "options": {
          "keepSource": "json"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        1616,
        1680
      ],
      "id": "a015ff52-a41d-4dca-b76d-4a261b82c32a",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ JSON.stringify($input.first().json) }}\n",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a meticulous nutrition data verifier. Your job is to check if the provided nutritional data for a given meal description is reasonable. The initial calculation was done by another AI, and you are the quality check.\n\nI will provide you with a JSON object containing a 'food_name' and its calculated nutrition.\n\nIf the numbers seem reasonable for the food described, return the JSON object exactly as you received it.\n\nIf the numbers seem wildly incorrect (e.g., 1700 calories for a piece of chicken), recalculate them based on your knowledge and return a JSON object with the corrected values.\n\nDo not add any explanation, apologies, or extra text. Your output MUST be only the JSON object in the exact same format as the input.\n\nHere is the required format:\n{\n\"food_name\": \"A descriptive name of the meal\",\n\"calories\": number,\n\"protein\": number,\n\"fat\": number,\n\"carbs\": number,\n\"fiber\": number\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        2272,
        1792
      ],
      "id": "0c203247-29b2-494c-8423-ab618d9ac6ff",
      "name": "Verify Nutrition with AI Agent"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"food_name\": {\n      \"type\": \"string\",\n      \"description\": \"A descriptive name of the meal, like 'Chicken and Rice' or 'Protein Shake'\"\n    },\n    \"calories\": {\n      \"type\": \"number\",\n      \"description\": \"Total calories for the meal\"\n    },\n    \"protein\": {\n      \"type\": \"number\",\n      \"description\": \"Total protein in grams for the meal\"\n    },\n    \"fat\": {\n      \"type\": \"number\",\n      \"description\": \"Total fat in grams for the meal\"\n    },\n    \"carbs\": {\n      \"type\": \"number\",\n      \"description\": \"Total carbs in grams for the meal\"\n    },\n    \"fiber\": {\n      \"type\": \"number\",\n      \"description\": \"Total fiber in grams for the meal\"\n    }\n  },\n  \"required\": [\n    \"food_name\",\n    \"calories\",\n    \"protein\",\n    \"fat\",\n    \"carbs\",\n    \"fiber\"\n  ]\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        2448,
        2080
      ],
      "id": "20cd6194-4a60-4087-82d0-451739e3c0d7",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": "deepseek/deepseek-chat-v3-0324:free",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        2208,
        2080
      ],
      "id": "caf8d993-58a0-4ebf-aeaa-27b20355c12c",
      "name": "DEEPSEEK",
      "credentials": {
        "openRouterApi": {
          "id": "Z0qdSGsCKeFZM9R5",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get the original data from before the verification step\nconst originalData = $('Calculate Nutrition1').item.json;\n\n// Get the verified data from the verifier AI\n// Note: The AI Agent node might put the response in a different place than the HTTP node.\n// We'll check for a 'content' or direct property.\nconst aiResponse = $input.first().json;\nconst verifiedDataString = aiResponse.content || JSON.stringify(aiResponse);\nconst verifiedData = JSON.parse(verifiedDataString);\n\n\n// Combine them into the final object for Notion\nconst result = {\n  ...verifiedData, // Use the verified food_name, calories, protein, etc.\n  date: originalData.date,\n  time: originalData.time,\n  telegram_user_id: originalData.telegram_user_id,\n  telegram_username: originalData.telegram_username,\n};\n\nreturn { json: result };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2624,
        1792
      ],
      "id": "ac3a7ce2-c846-4342-993d-cc9dd5d29827",
      "name": "Finalize for Notion"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        2384,
        2000
      ],
      "id": "5eb7a8f4-b1fd-42bd-aece-47ea7d37208a",
      "name": "Think"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-07-31T16:10:47.422Z",
  "versionId": "58a26440-74f5-41e1-86e0-165b2bfc87d3"
}